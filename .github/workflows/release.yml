name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds (on ubuntu)
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          # Windows builds (on windows)
          - os: windows-latest
            goos: windows
            goarch: amd64
          # macOS builds (on macos) - both architectures
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.5'
      
      - name: Build
        id: build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          if [ "${{ matrix.goos }}" = "windows" ]; then
            OUTPUT_FILE="terraform-provider-httpx_${{ matrix.goos }}_${{ matrix.goarch }}.exe"
          else
            OUTPUT_FILE="terraform-provider-httpx_${{ matrix.goos }}_${{ matrix.goarch }}"
          fi
          go build -ldflags "-X main.version=${VERSION}" -o "$OUTPUT_FILE" .
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "Built: $OUTPUT_FILE"
          ls -la "$OUTPUT_FILE" || echo "File not found!"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: terraform-provider-httpx-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ steps.build.outputs.output_file }}
          if-no-files-found: error
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: terraform-provider-httpx-*
          merge-multiple: false
      
      - name: Prepare release assets
        shell: bash
        run: |
          mkdir -p release-assets
          # Debug: Show artifact structure
          echo "Artifact directory structure:"
          find artifacts -type f -ls || true
          echo ""
          # Find and copy all artifacts (they are in subdirectories per artifact)
          # Look for files matching the expected naming pattern
          find artifacts -type f -name "terraform-provider-httpx_*" -exec cp {} release-assets/ \;
          # Verify all files are present
          cd release-assets
          echo "Release assets:"
          ls -lah
          # Verify we have all 4 expected binaries
          COUNT=$(ls -1 | wc -l)
          if [ "$COUNT" -ne 4 ]; then
            echo "Error: Expected 4 binaries, found $COUNT"
            echo "Files found:"
            ls -1
            echo ""
            echo "Expected files:"
            echo "  - terraform-provider-httpx_linux_amd64"
            echo "  - terraform-provider-httpx_windows_amd64.exe"
            echo "  - terraform-provider-httpx_darwin_amd64"
            echo "  - terraform-provider-httpx_darwin_arm64"
            exit 1
          fi
          echo "Successfully prepared all 4 release assets"
      
      - name: Extract version from tag
        id: tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"
      
      - name: Import GPG key
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE || '' }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key (required for signing)
          # Extract the full fingerprint (the long hex string on the line after "sec")
          FINGERPRINT=$(gpg --list-secret-keys --keyid-format LONG "$GPG_KEY_ID" | grep -A 1 "^sec" | tail -1 | xargs)
          if [ -z "$FINGERPRINT" ]; then
            echo "Error: Could not extract fingerprint for key $GPG_KEY_ID"
            echo "Available keys:"
            gpg --list-secret-keys --keyid-format LONG
            exit 1
          fi
          echo "Setting trust for fingerprint: $FINGERPRINT"
          echo "$FINGERPRINT:6:" | gpg --import-ownertrust
          # Verify the key is imported and trusted
          echo "Imported keys:"
          gpg --list-secret-keys --keyid-format LONG
      
      - name: Generate SHASUMS file
        run: |
          cd release-assets
          # Generate SHA256 checksums for all binaries (Terraform Registry requirement)
          # Format: SHA256  filename
          shasum -a 256 terraform-provider-httpx_* > SHASUMS
          echo "SHASUMS file contents:"
          cat SHASUMS
          echo ""
          echo "Verifying SHASUMS file:"
          wc -l SHASUMS
          echo "Expected 4 lines (one per platform)"
      
      - name: Sign release assets
        if: env.GPG_PRIVATE_KEY != ''
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE || '' }}
        run: |
          cd release-assets
          # Sign individual binaries
          # If passphrase is empty, sign without passphrase option
          for file in terraform-provider-httpx_*; do
            echo "Signing $file with key $GPG_KEY_ID..."
            if [ -z "$GPG_PASSPHRASE" ]; then
              gpg --batch --yes --pinentry-mode loopback --default-key "$GPG_KEY_ID" --armor --detach-sign "$file"
            else
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --default-key "$GPG_KEY_ID" --armor --detach-sign "$file"
            fi
          done
          # Sign SHASUMS file (required by Terraform Registry)
          echo "Signing SHASUMS file..."
          if [ -z "$GPG_PASSPHRASE" ]; then
            gpg --batch --yes --pinentry-mode loopback --default-key "$GPG_KEY_ID" --armor --detach-sign SHASUMS
          else
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --default-key "$GPG_KEY_ID" --armor --detach-sign SHASUMS
          fi
          # Verify SHASUMS signature was created
          if [ ! -f SHASUMS.asc ]; then
            echo "Error: SHASUMS.asc was not created!"
            exit 1
          fi
          echo "Signed files:"
          ls -lah *.asc || echo "No signature files found"
          echo ""
          echo "SHASUMS files:"
          ls -lah SHASUMS* || echo "No SHASUMS files found"
          echo ""
          echo "Verifying release assets:"
          echo "Binaries: $(ls -1 terraform-provider-httpx_* | wc -l)"
          echo "Signatures: $(ls -1 *.asc | wc -l)"
          echo "SHASUMS files: $(ls -1 SHASUMS* | wc -l)"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          name: Release ${{ steps.tag.outputs.version }}
          body: |
            ## Terraform HTTP Provider ${{ steps.tag.outputs.version }}
            
            ### Downloads
            
            Binaries are available for the following platforms:
            - Linux (amd64)
            - Windows (amd64)
            - macOS Intel (amd64)
            - macOS Apple Silicon (arm64)
            
            ### Installation
            
            See [TESTING.md](TESTING.md) for local installation instructions.
            
            ### Changes
            
            See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
            
            ### Verification
            
            All binaries are signed with GPG. To verify:
            ```bash
            gpg --verify terraform-provider-httpx_<platform>.<ext>.asc terraform-provider-httpx_<platform>.<ext>
            ```
          files: |
            release-assets/terraform-provider-httpx_*
            release-assets/*.asc
            release-assets/SHASUMS
            release-assets/SHASUMS.asc
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.version, '-') }}

