name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds (on ubuntu)
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          # Windows builds (on windows)
          - os: windows-latest
            goos: windows
            goarch: amd64
          # macOS builds (on macos) - both architectures
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.5'
      
      - name: Build
        id: build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        shell: bash
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VER=${TAG#v}

          # Build unique, per-platform filename to avoid collisions when artifacts are merged
          if [ "${{ matrix.goos }}" = "windows" ]; then
            OUT="terraform-provider-httpx_${{ matrix.goos }}_${{ matrix.goarch }}.exe"
          else
            OUT="terraform-provider-httpx_${{ matrix.goos }}_${{ matrix.goarch }}"
          fi

          go build -ldflags "-X main.version=${VER}" -o "$OUT" .
          echo "output_file=$OUT" >> $GITHUB_OUTPUT
          echo "Built: $OUT"
          ls -la "$OUT" || echo "File not found!"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: terraform-provider-httpx-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ steps.build.outputs.output_file }}
          if-no-files-found: error
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: terraform-provider-httpx-*
          merge-multiple: false
      
      - name: Prepare release assets
        shell: bash
        run: |
          mkdir -p release-assets
          # Debug: Show artifact structure
          echo "Artifact directory structure:"
          find artifacts -type f -ls || true
          echo ""
          # Find and copy all artifacts (they are in subdirectories per artifact)
          # Look for files matching the expected naming pattern
          find artifacts -type f -name "terraform-provider-httpx_*" -exec cp {} release-assets/ \;
          # Verify all files are present
          cd release-assets
          echo "Release assets:"
          ls -lah
          # Verify we have all 4 expected binaries
          COUNT=$(ls -1 terraform-provider-httpx_* | wc -l)
          if [ "$COUNT" -ne 4 ]; then
            echo "Error: Expected 4 binaries, found $COUNT"
            echo "Files found:"
            ls -1
            echo ""
            echo "Expected files:"
            echo "  - terraform-provider-httpx_linux_amd64"
            echo "  - terraform-provider-httpx_windows_amd64.exe"
            echo "  - terraform-provider-httpx_darwin_amd64"
            echo "  - terraform-provider-httpx_darwin_arm64"
            exit 1
          fi
          echo "Successfully prepared all 4 release assets"
      
      - name: Extract version from tag
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VER=${TAG#v}
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ver=$VER" >> $GITHUB_OUTPUT
          echo "Tag: $TAG, Version: $VER"
      
      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE || '' }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "Warning: GPG_PRIVATE_KEY secret not set, skipping GPG signing"
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          # Trust the key (required for signing)
          # Extract the full fingerprint (the long hex string on the line after "sec")
          FINGERPRINT=$(gpg --list-secret-keys --keyid-format LONG "$GPG_KEY_ID" | grep -A 1 "^sec" | tail -1 | xargs)
          if [ -z "$FINGERPRINT" ]; then
            echo "Error: Could not extract fingerprint for key $GPG_KEY_ID"
            echo "Available keys:"
            gpg --list-secret-keys --keyid-format LONG
            exit 1
          fi
          echo "Setting trust for fingerprint: $FINGERPRINT"
          echo "$FINGERPRINT:6:" | gpg --import-ownertrust
          # Verify the key is imported and trusted
          echo "Imported keys:"
          gpg --list-secret-keys --keyid-format LONG
      
      - name: Prepare release assets (create zips)
        run: |
          cd release-assets
          echo "Creating zip files for Terraform Registry..."
          VER="${{ steps.tag.outputs.ver }}"

          # Terraform Registry requires:
          # - Zip filename (NO leading v): terraform-provider-httpx_${VER}_<os>_<arch>.zip
          # - Binary inside zip (YES leading v): terraform-provider-httpx_v${VER}[.exe]

          # Ensure all binaries are executable before zipping
          # This prevents "permission denied" errors when users extract the provider
          chmod +x terraform-provider-httpx_*
          
          # Linux
          cp "terraform-provider-httpx_linux_amd64" "terraform-provider-httpx_v${VER}"
          chmod +x "terraform-provider-httpx_v${VER}"
          zip -j "terraform-provider-httpx_${VER}_linux_amd64.zip" "terraform-provider-httpx_v${VER}"
          rm -f "terraform-provider-httpx_v${VER}"

          # Darwin amd64
          cp "terraform-provider-httpx_darwin_amd64" "terraform-provider-httpx_v${VER}"
          chmod +x "terraform-provider-httpx_v${VER}"
          zip -j "terraform-provider-httpx_${VER}_darwin_amd64.zip" "terraform-provider-httpx_v${VER}"
          rm -f "terraform-provider-httpx_v${VER}"

          # Darwin arm64
          cp "terraform-provider-httpx_darwin_arm64" "terraform-provider-httpx_v${VER}"
          chmod +x "terraform-provider-httpx_v${VER}"
          zip -j "terraform-provider-httpx_${VER}_darwin_arm64.zip" "terraform-provider-httpx_v${VER}"
          rm -f "terraform-provider-httpx_v${VER}"

          # Windows amd64
          cp "terraform-provider-httpx_windows_amd64.exe" "terraform-provider-httpx_v${VER}.exe"
          zip -j "terraform-provider-httpx_${VER}_windows_amd64.zip" "terraform-provider-httpx_v${VER}.exe"
          rm -f "terraform-provider-httpx_v${VER}.exe"

          echo "Created zip files:"
          ls -lh terraform-provider-httpx_${VER}_*.zip

          # Verify binary names inside zips
          echo ""
          echo "Verifying binary names inside zips:"
          unzip -l "terraform-provider-httpx_${VER}_linux_amd64.zip" | grep terraform-provider-httpx

          # Copy manifest file for Terraform Registry
          cp ../terraform-registry-manifest.json "terraform-provider-httpx_${VER}_manifest.json"

          echo ""
          echo "Release-ready files:"
          ls -lh terraform-provider-httpx_${VER}_*
      
      - name: Generate SHASUMS file
        run: |
          cd release-assets
          VER="${{ steps.tag.outputs.ver }}"
          SHASUMS_FILE="terraform-provider-httpx_${VER}_SHA256SUMS"
          
          echo "Generating SHASUMS file..."
          # Include ONLY: zips + manifest (NOT raw binaries)
          shasum -a 256 \
            terraform-provider-httpx_${VER}_*.zip \
            terraform-provider-httpx_${VER}_manifest.json \
            > "$SHASUMS_FILE"
          
          echo ""
          echo "SHASUMS file contents:"
          cat "$SHASUMS_FILE"
          echo ""
          echo "Line count (expected: 5 = 4 zips + 1 manifest):"
          wc -l "$SHASUMS_FILE"
      
      - name: Sign release assets
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE || '' }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ] || [ -z "$GPG_KEY_ID" ]; then
            echo "Warning: GPG secrets not set, skipping signing"
            exit 0
          fi
          cd release-assets
          VER="${{ steps.tag.outputs.ver }}"
          
          echo "Signing Terraform Registry-required files..."
          echo "Sign ONLY: .zip files, manifest.json, and SHA256SUMS"
          echo ""
          
          # Sign each zip file
          for file in terraform-provider-httpx_${VER}_*.zip; do
            echo "Signing $file..."
            if [ -z "$GPG_PASSPHRASE" ]; then
              gpg --batch --yes --armor --detach-sign "$file"
            else
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --armor --detach-sign "$file"
            fi
          done
          
          # Sign manifest file
          MANIFEST="terraform-provider-httpx_${VER}_manifest.json"
          echo "Signing $MANIFEST..."
          if [ -z "$GPG_PASSPHRASE" ]; then
            gpg --batch --yes --armor --detach-sign "$MANIFEST"
          else
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --armor --detach-sign "$MANIFEST"
          fi
          
          # Sign SHASUMS file (Terraform Registry requires a *binary* detached signature)
          SHASUMS="terraform-provider-httpx_${VER}_SHA256SUMS"
          echo "Signing $SHASUMS (binary .sig)..."

          # Ensure we don't have stale signature files from previous runs
          rm -f "${SHASUMS}.sig" "${SHASUMS}.asc" || true

          if [ -z "$GPG_PASSPHRASE" ]; then
            gpg --batch --yes --pinentry-mode loopback \
              --detach-sign --output "${SHASUMS}.sig" "$SHASUMS"
          else
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback \
              --passphrase-fd 0 \
              --detach-sign --output "${SHASUMS}.sig" "$SHASUMS"
          fi

          # Verify signature file exists
          if [ ! -f "${SHASUMS}.sig" ]; then
            echo "Error: SHASUMS binary signature was not created: ${SHASUMS}.sig"
            exit 1
          fi

          file "${SHASUMS}.sig" || true
          
          echo ""
          echo "Final release-assets directory:"
          ls -lh terraform-provider-httpx_${VER}_*
      
      - name: Verify release assets
        run: |
          cd release-assets
          VER="${{ steps.tag.outputs.ver }}"
          
          echo "Final release assets for Terraform Registry:"
          ls -lh terraform-provider-httpx_${VER}_*
          
          echo ""
          echo "Verifying zip file contents (binary must have leading v):"
          unzip -l "terraform-provider-httpx_${VER}_linux_amd64.zip"
          
          echo ""
          echo "Release is ready! Files to be uploaded:"
          find . -maxdepth 1 -type f -name "terraform-provider-httpx_${VER}_*" | sort

      - name: Remove raw binaries from release upload
        run: |
          cd release-assets
          VER="${{ steps.tag.outputs.ver }}"
          rm -f terraform-provider-httpx_linux_amd64 terraform-provider-httpx_darwin_amd64 terraform-provider-httpx_darwin_arm64 terraform-provider-httpx_windows_amd64.exe
          # Remove any detached signatures for raw binaries if present
          rm -f terraform-provider-httpx_linux_amd64.asc terraform-provider-httpx_darwin_amd64.asc terraform-provider-httpx_darwin_arm64.asc terraform-provider-httpx_windows_amd64.exe.asc
          echo "Remaining files to upload:"
          ls -lh terraform-provider-httpx_${VER}_*
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Terraform HTTP Provider ${{ steps.tag.outputs.tag }}
            
            ### Downloads
            
            Binaries are available for the following platforms:
            - Linux (amd64)
            - Windows (amd64)
            - macOS Intel (amd64)
            - macOS Apple Silicon (arm64)
            
            ### Installation
            
            See [TESTING.md](TESTING.md) for local installation instructions.
            
            ### Changes
            
            See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
            
            ### Terraform Registry
            
            This provider is published to the Terraform Registry and can be installed via:
            ```hcl
            terraform {
              required_providers {
                httpx = {
                  source  = "davidshato93/httpx"
                  version = "${{ steps.tag.outputs.ver }}"
                }
              }
            }
            ```
          files: |
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_linux_amd64.zip
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_darwin_amd64.zip
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_darwin_arm64.zip
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_windows_amd64.zip
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_manifest.json
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_SHA256SUMS
            release-assets/terraform-provider-httpx_${{ steps.tag.outputs.ver }}_SHA256SUMS.sig
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag, '-') }}
